<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Kubernetes Cluster Setup | myBlog</title><meta name="keywords" content="Big Data Systems"><meta name="author" content="Donald Lam,manholam8@gmail.com"><meta name="copyright" content="Donald Lam"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Pig Installation Download the latest version of Pig from Apache12wget https:&#x2F;&#x2F;dlcdn.apache.org&#x2F;pig&#x2F;pig-0.17.0&#x2F;pig-0.17.0.tar.gztar xvzf pig-0.17.0.tar.gz    Change the directory of pig-0.17.0 folder 1">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Cluster Setup">
<meta property="og:url" content="https://github.com/DonaldLamNL/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/index.html">
<meta property="og:site_name" content="myBlog">
<meta property="og:description" content="Pig Installation Download the latest version of Pig from Apache12wget https:&#x2F;&#x2F;dlcdn.apache.org&#x2F;pig&#x2F;pig-0.17.0&#x2F;pig-0.17.0.tar.gztar xvzf pig-0.17.0.tar.gz    Change the directory of pig-0.17.0 folder 1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://p.ipic.vip/hwdr0p.jpg">
<meta property="article:published_time" content="2024-02-16T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-16T16:00:00.000Z">
<meta property="article:author" content="Donald Lam">
<meta property="article:tag" content="Big Data Systems">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.ipic.vip/hwdr0p.jpg"><link rel="shortcut icon" href="/myBlog/img/favicon.png"><link rel="canonical" href="https://github.com/DonaldLamNL/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/myBlog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/myBlog/',
  algolia: undefined,
  localSearch: {"path":"/myBlog/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes Cluster Setup',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-17 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://p.ipic.vip/5dc8z2.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/myBlog/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/myBlog/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/myBlog/categories/"><div class="headline">Categories</div><div class="length-num">14</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myBlog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://p.ipic.vip/hwdr0p.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/myBlog/">myBlog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myBlog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/myBlog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes Cluster Setup</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-02-16T16:00:00.000Z" title="Created 2024-02-17 00:00:00">2024-02-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-02-16T16:00:00.000Z" title="Updated 2024-02-17 00:00:00">2024-02-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/myBlog/categories/ESTR4316/">ESTR4316</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kubernetes Cluster Setup"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Pig-Installation"><a href="#Pig-Installation" class="headerlink" title="Pig Installation"></a>Pig Installation</h2><ol>
<li>Download the latest version of Pig from Apache<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://dlcdn.apache.org/pig/pig-0.17.0/pig-0.17.0.tar.gz</span><br><span class="line">tar xvzf pig-0.17.0.tar.gz</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>Change the directory of pig-0.17.0 folder</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /usr/local/pig</span><br><span class="line"><span class="built_in">cd</span> pig-0.17.0</span><br><span class="line">sudo <span class="built_in">mv</span> * /usr/local/pig</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create <code>.bashrc</code> file with following environment</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi .bashrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PIG_HOME=/usr/local/pig</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$PIG_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PIG_CLASSPATH=<span class="variable">$PIG_HOME</span>/conf:<span class="variable">$HADOOP_INSTALL</span>/etc/hadoop/bin</span><br><span class="line"><span class="built_in">export</span> PIG_CONF_DIR=<span class="variable">$PIG_HOME</span>/conf</span><br><span class="line"><span class="built_in">export</span> PIG_CLASSPATH=<span class="variable">$PIG_CONF_DIR</span></span><br><span class="line"><span class="comment"># PIG VARIABLES END</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> .bashrc</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Multi-node-Kubernetes-Cluster"><a href="#Multi-node-Kubernetes-Cluster" class="headerlink" title="Multi-node Kubernetes Cluster"></a>Multi-node Kubernetes Cluster</h2><h3 id="Disable-Swap"><a href="#Disable-Swap" class="headerlink" title="Disable Swap"></a>Disable Swap</h3><p>The default behavior of a kubelet was to fail to start if swap memory was detected on a node. You MUST disable swap if the kubelet is not properly configured to use swap.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br><span class="line">sudo sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure></p>
<h3 id="Add-kernel-Parameters"><a href="#Add-kernel-Parameters" class="headerlink" title="Add kernel Parameters"></a>Add kernel Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/modules-load.d/containerd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> /etc/sysctl.d/kubernetes.conf &lt;&lt;<span class="string">EOT</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>
<h3 id="Install-Container"><a href="#Install-Container" class="headerlink" title="Install Container"></a>Install Container</h3><p>To set up Kubernetes Cluster, you must install the container runtime on all servers so that Pods can run. Multiple container runtimes can be used for Kubernetes deployments such as containerd, CRI-O, Mirantis Container Runtime, and Docker Engine (via cri-dockerd).<br>When it is used as a container runtime for Kubernetes, Docker is just a middle-man between Kubernetes and containerd. However, Kubernetes can use containerd directly as a container runtime, meaning Docker is no longer needed in this middle-man role.<br>So, to install containerd, first install its dependencies.</p>
<h4 id="Install-Containerd-Runtime"><a href="#Install-Containerd-Runtime" class="headerlink" title="Install Containerd Runtime"></a>Install Containerd Runtime</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/docker.gpg</span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y containerd.io</span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/SystemdCgroup \= false/SystemdCgroup \= true/g&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart containerd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd</span><br></pre></td></tr></table></figure>
<h4 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install ca-certificates curl</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc</span><br><span class="line">sudo <span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.asc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line"><span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string"><span class="subst">$(. /etc/os-release &amp;&amp; echo <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<h3 id="Install-Kubernetes-Package"><a href="#Install-Kubernetes-Package" class="headerlink" title="Install Kubernetes Package"></a>Install Kubernetes Package</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /&#x27;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<h3 id="Install-Kubernetes-Cluster"><a href="#Install-Kubernetes-Cluster" class="headerlink" title="Install Kubernetes Cluster"></a>Install Kubernetes Cluster</h3><h4 id="Initialize-Control-plane-Node"><a href="#Initialize-Control-plane-Node" class="headerlink" title="Initialize Control-plane Node"></a>Initialize Control-plane Node</h4><ul>
<li><p><strong>Initialize Control-plane Node</strong><br>Execute the following command to initialize the control-plane node in the master node that we treat it as control-plane node. Run the following command on the <strong><font color="F54747">master node</font></strong>.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --control-plane-endpoint=&lt;node-name&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Start interacting with cluster</strong><br>Run following commands on the control-plane node (<strong><font color="F54747">master node</font></strong>):</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Control-plane Node Isolation</strong><br>By default, the cluster will not schedule Pods on the control plane nodes for security reasons. If you want to be able to schedule Pods on the control plane nodes, for example for a <strong><font color="F54747">single machine Kubernetes cluster</font></strong>, run:</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/control-plane-</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Join-Worker-Nodes"><a href="#Join-Worker-Nodes" class="headerlink" title="Join Worker Nodes"></a>Join Worker Nodes</h4><p>Run following commands on the <strong><font color="F54747">worker nodes</font></strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> --token &lt;token&gt; &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Reset-the-Cluster"><a href="#Reset-the-Cluster" class="headerlink" title="Reset the Cluster"></a>Reset the Cluster</h4><p>Execute the following command on all nodes to reset the node and remove the folder</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm reset</span><br><span class="line"><span class="built_in">rm</span> -r <span class="variable">$HOME</span>/.kube</span><br></pre></td></tr></table></figure>
<h3 id="Install-Calico-Network-Plugin"><a href="#Install-Calico-Network-Plugin" class="headerlink" title="Install Calico Network Plugin"></a>Install Calico Network Plugin</h3><p>A network plugin is required to enable communication between pods in the cluster. Run following kubectl command to install Calico network plugin from the master node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/calico.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>
<h3 id="Deploy-Hadoop"><a href="#Deploy-Hadoop" class="headerlink" title="Deploy Hadoop"></a>Deploy Hadoop</h3><ul>
<li><p><strong>Deployment</strong><br>Deploy the hadoop using the yaml script.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://mobitec.ie.cuhk.edu.hk/ierg4330/static_files/assignments/hadoop.yaml</span><br><span class="line">kubectl create -f hadoop.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Validation</strong><br>Check the distribution of the pods and containers, visit the Hadoop and Application Master UI via the IP of the instance which setup the <code>hdfs-master</code> pod.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o wide</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>Execution</strong><br>Submit the MapReduce jobs through the <code>yarn-master</code> pod.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it yarn-master -- /bin/bash</span><br><span class="line">  </span><br><span class="line"><span class="comment"># Teragen</span></span><br><span class="line">hadoop jar /usr/local/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar teragen 20000000 /user/hadoop/input2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Terasort</span></span><br><span class="line">hadoop jar /usr/local/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar terasort /user/hadoop/input2 /user/hadoop/output_fault</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>Deletion</strong><br>Delete all pods, services and deployments.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f hadoop.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<!-- 
<img src="" width="500px" />
<font color="3A75EA">Blue</font>
<font color="F54747">Red</font>
-->
<p>cd $SPARK_HOME<br>spark-submit \<br>    —master k8s://<a target="_blank" rel="noopener" href="https://vm-1:6443">https://vm-1:6443</a> \<br>    —deploy-mode cluster \<br>    —name spark-pi \<br>    —class org.apache.spark.examples.SparkPi \<br>    —conf spark.executor.instances=5 \<br>    —conf spark.kubernetes.namespace=spark \<br>    —conf spark.kubernetes.authenticate.driver.serviceAccountName=spark \<br>    —conf spark.kubernetes.container.image=manholam8/spark:3.5.1-hadoop3 \<br>    local:///opt/spark/examples/jars/spark-examples_2.12-3.5.1.jar</p>
<p>$SPARK_HOME/bin/docker-image-tool.sh -r myharbor.com/bigdata -t 3.5.1-hadoop3 build  build<br>$SPARK_HOME/bin/docker-image-tool.sh -r myharbor.com/bigdata -t 3.5.1-hadoop3 push</p>
<p>sudo $SPARK_HOME/bin/docker-image-tool.sh -r my-spark-exmaple -t 3.5.1 build</p>
<p>val sparkConf = new SparkConf()<br>    .setAppName(“MySparkApp”)<br>    .setMaster(“k8s://<a target="_blank" rel="noopener" href="https://vm-1:6443">https://vm-1:6443</a>“)<br>    .set(“spark.kubernetes.container.image”, “manholam8/spark:3.5.1”)<br>    .set(“spark.executor.instances”, “2”)<br>    .set(“spark.executor.memory”, “2g”)<br>    .set(“spark.executor.cores”, “1”)</p>
<p>spark-submit \<br>    —master k8s://<a target="_blank" rel="noopener" href="https://vm-1:6443">https://vm-1:6443</a> \<br>    —deploy-mode cluster \<br>    —name spark-pi \<br>    —class org.apache.spark.examples.SparkPi \<br>    —conf spark.executor.instances=5 \<br>    —conf spark.kubernetes.namespace=spark \<br>    —conf spark.kubernetes.authenticate.driver.serviceAccountName=spark \<br>    —conf spark.kubernetes.container.image=manholam8/spark:3.5.1 \<br>    local:///opt/spark/examples/jars/spark-examples_2.12-3.5.1.jar</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://github.com/DonaldLamNL/myBlog">Donald Lam</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://github.com/DonaldLamNL/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/">https://github.com/DonaldLamNL/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/myBlog/tags/Big-Data-Systems/">Big Data Systems</a></div><div class="post_share"><div class="social-share" data-image="https://p.ipic.vip/hwdr0p.jpg" data-sites="facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/myBlog/2024/02/17/CUHK/AIST4010/2024-2-17-AIST4010-Optimization/"><img class="prev-cover" src="https://p.ipic.vip/llqylk.jpg" onerror="onerror=null;src='/myBlog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Optimization</div></div></a></div><div class="next-post pull-right"><a href="/myBlog/2024/02/04/CUHK/AIST4010/2024-2-4-AIST4010-Increase-dimension/"><img class="next-cover" src="https://p.ipic.vip/llqylk.jpg" onerror="onerror=null;src='/myBlog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CNN++ (Increase Dimension)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/myBlog/2023/09/15/CUHK/CSCI4180/2023-9-15-CSCI4180-Hadoop/" title="Hadoop Overview"><img class="cover" src="https://p.ipic.vip/hwdr0p.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-15</div><div class="title">Hadoop Overview</div></div></a></div><div><a href="/myBlog/2024/01/18/CUHK/ESTR4316/2024-1-18-ESTR4316-Introduction/" title="Resource Management and Infrastructure"><img class="cover" src="https://p.ipic.vip/hwdr0p.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-18</div><div class="title">Resource Management and Infrastructure</div></div></a></div><div><a href="/myBlog/2023/09/18/CUHK/ESTR4300/2023-9-18-ESTR4300-Hadoop-Clusters-Setup/" title="Hadoop Cluster Setup"><img class="cover" src="https://p.ipic.vip/hwdr0p.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-18</div><div class="title">Hadoop Cluster Setup</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://p.ipic.vip/5dc8z2.jpeg" onerror="this.onerror=null;this.src='/myBlog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Donald Lam</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/myBlog/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/myBlog/tags/"><div class="headline">Tags</div><div class="length-num">14</div></a><a href="/myBlog/categories/"><div class="headline">Categories</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://donaldlamnl.github.io/myWeb/#/home"><i></i><span>My Personal Website</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/DonaldLamNL" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:manholam8@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pig-Installation"><span class="toc-number">1.</span> <span class="toc-text">Pig Installation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multi-node-Kubernetes-Cluster"><span class="toc-number">2.</span> <span class="toc-text">Multi-node Kubernetes Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Disable-Swap"><span class="toc-number">2.1.</span> <span class="toc-text">Disable Swap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-kernel-Parameters"><span class="toc-number">2.2.</span> <span class="toc-text">Add kernel Parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-Container"><span class="toc-number">2.3.</span> <span class="toc-text">Install Container</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Install-Containerd-Runtime"><span class="toc-number">2.3.1.</span> <span class="toc-text">Install Containerd Runtime</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Install-Docker"><span class="toc-number">2.3.2.</span> <span class="toc-text">Install Docker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-Kubernetes-Package"><span class="toc-number">2.4.</span> <span class="toc-text">Install Kubernetes Package</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-Kubernetes-Cluster"><span class="toc-number">2.5.</span> <span class="toc-text">Install Kubernetes Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Initialize-Control-plane-Node"><span class="toc-number">2.5.1.</span> <span class="toc-text">Initialize Control-plane Node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Join-Worker-Nodes"><span class="toc-number">2.5.2.</span> <span class="toc-text">Join Worker Nodes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Reset-the-Cluster"><span class="toc-number">2.5.3.</span> <span class="toc-text">Reset the Cluster</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Install-Calico-Network-Plugin"><span class="toc-number">2.6.</span> <span class="toc-text">Install Calico Network Plugin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deploy-Hadoop"><span class="toc-number">2.7.</span> <span class="toc-text">Deploy Hadoop</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2024/02/17/CUHK/AIST4010/2024-2-17-AIST4010-Optimization/" title="Optimization"><img src="https://p.ipic.vip/llqylk.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.jpg'" alt="Optimization"/></a><div class="content"><a class="title" href="/myBlog/2024/02/17/CUHK/AIST4010/2024-2-17-AIST4010-Optimization/" title="Optimization">Optimization</a><time datetime="2024-02-16T16:00:00.000Z" title="Created 2024-02-17 00:00:00">2024-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/" title="Kubernetes Cluster Setup"><img src="https://p.ipic.vip/hwdr0p.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.jpg'" alt="Kubernetes Cluster Setup"/></a><div class="content"><a class="title" href="/myBlog/2024/02/17/CUHK/ESTR4316/2024-1-25-ESTR4316-Kubernates/" title="Kubernetes Cluster Setup">Kubernetes Cluster Setup</a><time datetime="2024-02-16T16:00:00.000Z" title="Created 2024-02-17 00:00:00">2024-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2024/02/04/CUHK/AIST4010/2024-2-4-AIST4010-Increase-dimension/" title="CNN++ (Increase Dimension)"><img src="https://p.ipic.vip/llqylk.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.jpg'" alt="CNN++ (Increase Dimension)"/></a><div class="content"><a class="title" href="/myBlog/2024/02/04/CUHK/AIST4010/2024-2-4-AIST4010-Increase-dimension/" title="CNN++ (Increase Dimension)">CNN++ (Increase Dimension)</a><time datetime="2024-02-03T16:00:00.000Z" title="Created 2024-02-04 00:00:00">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2024/02/03/CUHK/AIST4010/2024-2-3-AIST4010-Model-Architectures/" title="CNN++ (Model Architectures)"><img src="https://p.ipic.vip/llqylk.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.jpg'" alt="CNN++ (Model Architectures)"/></a><div class="content"><a class="title" href="/myBlog/2024/02/03/CUHK/AIST4010/2024-2-3-AIST4010-Model-Architectures/" title="CNN++ (Model Architectures)">CNN++ (Model Architectures)</a><time datetime="2024-02-02T16:00:00.000Z" title="Created 2024-02-03 00:00:00">2024-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myBlog/2024/01/30/CUHK/AIST4010/2024-1-30-AIST4010-Convolutional-Neural-Network/" title="Convolutional Neural Network"><img src="https://p.ipic.vip/llqylk.jpg" onerror="this.onerror=null;this.src='/myBlog/img/404.jpg'" alt="Convolutional Neural Network"/></a><div class="content"><a class="title" href="/myBlog/2024/01/30/CUHK/AIST4010/2024-1-30-AIST4010-Convolutional-Neural-Network/" title="Convolutional Neural Network">Convolutional Neural Network</a><time datetime="2024-01-29T16:00:00.000Z" title="Created 2024-01-30 00:00:00">2024-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By Donald Lam</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/myBlog/js/utils.js"></script><script src="/myBlog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/myBlog/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>